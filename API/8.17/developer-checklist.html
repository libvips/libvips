<!--
SPDX-FileCopyrightText: libvips team and contributors

SPDX-License-Identifier: LGPL-2.1-or-later
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <title>Vips &ndash; 8.0: Using &gt; Checklist for libvips users</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta charset="utf-8" />

  
  <meta property="og:type" content="website"/>

  

  
  <meta property="og:title" content="Vips: Using &gt; Checklist for libvips users"/>
  <meta property="og:description" content="Reference for Vips-8.0: Using &gt; Checklist for libvips users"/>
  <meta name="twitter:title" content="Vips: Using &gt; Checklist for libvips users"/>
  <meta name="twitter:description" content="Reference for Vips-8.0: Using &gt; Checklist for libvips users"/>


  
  <meta name="twitter:card" content="summary"/>

  
  
  
  <link rel="search" type="application/opensearchdescription+xml" title="Vips" href="opensearch.xml">
  
  

  <link rel="stylesheet" href="style.css" type="text/css" />

  

  
  <script src="urlmap.js"></script>
  
  
  <script src="fzy.js"></script>
  <script src="search.js"></script>
  
  <script src="main.js"></script>

  
</head>

<body>
  <div id="body-wrapper" tabindex="-1">

    <nav class="sidebar devhelp-hidden">
      
      
      <div class="search section">
        <form id="search-form" autocomplete="off">
          <input id="search-input" type="text" name="do-not-autocomplete" placeholder="Click, or press 's' to search" autocomplete="off"/>
        </form>
      </div>
      
      <div class="section namespace">
        <h3><a href="index.html">Vips</a></h3>
        <p>API Version: 8.0</p>
        
        <p>Library Version: 8.17</p>
        
      </div>
      
      
      <div class="section generator">
        <p>Generated by <a href="https://gitlab.gnome.org/GNOME/gi-docgen">gi-docgen</a> 2025.3</p>
      </div>
    </nav>

    <button id="btn-to-top" class="hidden"><span class="up-arrow"></span></button>

    
<section id="main" class="content">
  
  <h4 id="title" style="display:flex;">
    Using &gt; Checklist for libvips users
    <a href="#title" class="anchor"></a>
    
    <a class="srclink" title="go to source location" href="https://github.com/libvips/libvips/blob/master/doc/developer-checklist.md">[src]</a>
    
  </h4>
  
  <section>
    <div class="docblock">
    <p>libvips is a slightly unusual library and you may need to take some of its
stranger features into account when you design software that uses&nbsp;it.</p>
<h2 id="if-you-can-use-vips_thumbnail-not-vips_resize">If you can, use <a href="ctor.Image.thumbnail.html"><code>vips_thumbnail()</code></a>, not <a href="method.Image.resize.html"><code>vips_resize()</code></a><a class="md-anchor" href="#if-you-can-use-vips_thumbnail-not-vips_resize" title="Permanent link"></a></h2>
<p>The <a href="ctor.Image.thumbnail.html"><code>vips_thumbnail()</code></a> operation combines load and resize into one step.
This lets it take advantage of format library features, such as shrink on
load, and can lead to a large improvement in speed and a large drop in memory&nbsp;use.</p>
<p>For example, with this <span class="caps">JPEG</span>&nbsp;image:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>vipsheader<span class="w"> </span>nina.jpg
nina.jpg:<span class="w"> </span>6048x4032<span class="w"> </span>uchar,<span class="w"> </span><span class="m">3</span><span class="w"> </span>bands,<span class="w"> </span>srgb,<span class="w"> </span>jpegload
</code></pre></div>

<p>I&nbsp;see:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>/usr/bin/time<span class="w"> </span>-f<span class="w"> </span>%M:%e<span class="w"> </span>vips<span class="w"> </span>resize<span class="w"> </span>nina.jpg<span class="w"> </span>x.jpg<span class="w"> </span><span class="m">0</span>.1
<span class="m">123648</span>:0.23
</code></pre></div>

<p>124 <span class="caps">MB</span> of <span class="caps">RAM</span> and 0.23s to shink by a factor of 10. With <code>thumbnail</code> it&#8217;s:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>/usr/bin/time<span class="w"> </span>-f<span class="w"> </span>%M:%e<span class="w"> </span>vips<span class="w"> </span>thumbnail<span class="w"> </span>nina.jpg<span class="w"> </span>x.jpg<span class="w"> </span><span class="m">605</span>
<span class="m">68864</span>:0.08
</code></pre></div>

<p>Now it&#8217;s 68 <span class="caps">MB</span> of memory and 0.08s &#8212; half the memory use, and 3x faster. In
fact the improvement is better than that, since the <code>vips</code> command takes a
while to start and needs a fair amount of&nbsp;memory:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>/usr/bin/time<span class="w"> </span>-f<span class="w"> </span>%M:%e<span class="w"> </span>vips<span class="w"> </span>&gt;<span class="w"> </span>/dev/null
<span class="m">31232</span>:0.02
</code></pre></div>

<p>31 <span class="caps">MB</span> and 0.02s, so <a href="ctor.Image.thumbnail.html"><code>vips_thumbnail()</code></a> is really 2.5x less memory and
4x&nbsp;faster.</p>
<p>You can see much larger improvements with other formats, and quality will
often be better as well, since <a href="ctor.Image.thumbnail.html"><code>vips_thumbnail()</code></a> will automatically
premultiply and can render vector images directly at the correct&nbsp;size.</p>
<h2 id="dont-use-vips_thumbnail_image">Don't use <a href="method.Image.thumbnail_image.html"><code>vips_thumbnail_image()</code></a><a class="md-anchor" href="#dont-use-vips_thumbnail_image" title="Permanent link"></a></h2>
<p>It&#8217;s just there for emergencies. It can&#8217;t do any of the rendering tricks,
so it&#8217;s not faster than <a href="method.Image.resize.html"><code>vips_resize()</code></a>. Use <a href="ctor.Image.thumbnail.html"><code>vips_thumbnail()</code></a> if
you&nbsp;can.</p>
<h2 id="use-sequential-mode-if-you-can">Use sequential mode if you can<a class="md-anchor" href="#use-sequential-mode-if-you-can" title="Permanent link"></a></h2>
<p>This is a hint you pass to <a href="ctor.Image.new_from_file.html"><code>vips_image_new_from_file()</code></a> and friends that signals that you
will only scan this image in the direction that the underlying load library
supports. This can give a useful improvement in speed and reduction in memory
use in many&nbsp;cases.</p>
<p>See <a href="how-it-opens-files.html">the &#8220;How it opens files&#8221; chapter</a> for background
on this&nbsp;feature.</p>
<h2 id="use-longer-pipelines-if-you-can">Use longer pipelines if you can<a class="md-anchor" href="#use-longer-pipelines-if-you-can" title="Permanent link"></a></h2>
<p>libvips is demand-driven, and uses partial images as intermediates. This
means you can construct long pipelines of image processing operations,
they won&#8217;t use much memory, and they&#8217;ll (usually) join&nbsp;efficiently.</p>
<p>libvips is horizontally threaded, meaning that threads run along
the pipeline of operations you are evaluating, not up and down images. This
means that libvips can (usually) parallelise longer pipelines more efficiently
than short&nbsp;ones.</p>
<p>If you can, aim for long pipelines of processing&nbsp;operations.</p>
<h2 id="cache-commonly-reused-images">Cache commonly reused images<a class="md-anchor" href="#cache-commonly-reused-images" title="Permanent link"></a></h2>
<p>If an image is reused repeatedly in one pipeline, it&#8217;ll be recomputed
each time. You can sometimes get a big speedup by keeping images like
this in memory rather than recalculating their pixels, see (for example),
<code>copy_memory()</code> in&nbsp;pyvips.</p>
<p>This can raise memory use, of&nbsp;course.</p>
<h2 id="adjust-the-order-of-operations-in-pipelines">Adjust the order of operations in pipelines<a class="md-anchor" href="#adjust-the-order-of-operations-in-pipelines" title="Permanent link"></a></h2>
<p>If you can, put large resizes right at the start (see <a href="ctor.Image.thumbnail.html"><code>vips_thumbnail()</code></a>
above), then area filters (sharpen, for example), and finally any point&nbsp;operations.</p>
<h2 id="only-enable-the-load-libraries-you-need">Only enable the load libraries you need<a class="md-anchor" href="#only-enable-the-load-libraries-you-need" title="Permanent link"></a></h2>
<p>libvips after version 8.13 has a system for enabling and disabling image load
libraries at runtime,&nbsp;see:</p>
<p><a href="https://www.libvips.org/2022/05/28/What's-new-in-8.13.html">https://www.libvips.org/2022/05/28/What&#8217;s-new-in-8.13.html</a></p>
<p>You can usually improve security and avoid memory spikes by only enabling
the image formats you really need. If you are handling untrusted data,
I would set the <code>VIPS_BLOCK_UNTRUSTED</code> env var and only use the loaders we
have tested for&nbsp;security.</p>
<p>Older versions of libvips need compile-time&nbsp;configuration.</p>
<h2 id="sanity-check-images-before-processing">Sanity-check images before processing<a class="md-anchor" href="#sanity-check-images-before-processing" title="Permanent link"></a></h2>
<p>libvips image open is always fast and safe, as long as you have disabled
load via imagemagick. This means you can open an image and sanity-check it
before further&nbsp;processing.</p>
<p>There are two main checks that are very&nbsp;worthwhile:</p>
<ol>
<li>
<p>Sanity check image dimensions to protect you from decompression
   bombs like those described at
   <a href="https://www.bamsoftware.com/hacks/deflate.html">https://www.bamsoftware.com/hacks/deflate.html</a></p>
</li>
<li>
<p>Check for interlaced (also called progressive)&nbsp;images.</p>
</li>
</ol>
<p>These are the ones that appear in low detail first, then progressively
   sharpen as they are&nbsp;downloaded.</p>
<p>The downside is that you don&#8217;t get the final pixels until the whole image
   is in memory, which prevents any streaming processing and hugely increases
   memory use. For&nbsp;example:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>/usr/bin/time<span class="w"> </span>-f<span class="w"> </span>%M:%e<span class="w"> </span>vipsthumbnail<span class="w"> </span>big-progressive.jpg
<span class="m">3732224</span>:4.23
$<span class="w"> </span>vips<span class="w"> </span>copy<span class="w"> </span>big-progressive.jpg<span class="w"> </span>x.jpg
$<span class="w"> </span>/usr/bin/time<span class="w"> </span>-f<span class="w"> </span>%M:%e<span class="w"> </span>vipsthumbnail<span class="w"> </span>x.jpg
<span class="m">72448</span>:0.26
</code></pre></div>

<p>So this progressive jpeg takes 4gb of memory and 4.3s to thumbnail, but
   exactly the same image as a regular jpeg takes 72mb and&nbsp;0.26s.</p>
<p>I would detect these horrors before processing by looking for the
   <code>interlaced</code> metadata item and either ban them, or if your users insist
   on uploading in this terrible format, push them to a separate low-priority
   queue on a special container. Keep them away from your main image&nbsp;path.</p>
<h2 id="linux-memory-allocator">Linux memory allocator<a class="md-anchor" href="#linux-memory-allocator" title="Permanent link"></a></h2>
<p>The default memory allocator on most glibc-based Linux systems (e.g.
Debian, Red Hat) is unsuitable for long-running, multi-threaded processes
that involve lots of small memory&nbsp;allocations.</p>
<p>To help avoid fragmentation and improve performance on these systems,
the use of an alternative memory allocator such as <a href="https://github.com/jemalloc/jemalloc">jemalloc</a> is&nbsp;recommended.</p>
<p>Those using musl-based Linux (e.g. Alpine) and non-Linux systems are&nbsp;unaffected.</p>
<h2 id="disable-the-libvips-operation-cache-if-you-dont-need-it">Disable the libvips operation cache if you don't need it<a class="md-anchor" href="#disable-the-libvips-operation-cache-if-you-dont-need-it" title="Permanent link"></a></h2>
<p>The libvips operation cache is not useful for image proxies (i.e. processing
many different images). Consider disabling this with <code>vips_cache_set_max(0);</code>.</p>
    </div>
  </section>
</section>


    
<div id="toc" class="toc">
  <nav aria-labelledby="toc-title">
    <p id="toc-title">Content</p>
    <ul class="toc-list">
      
        
        <li class="toc-list-item"><a href="#if-you-can-use-vips_thumbnail-not-vips_resize"><span class="link-text">If you can, use vips_thumbnail(), not vips_resize()</span></a></li>
          
        
        <li class="toc-list-item"><a href="#dont-use-vips_thumbnail_image"><span class="link-text">Don&#39;t use vips_thumbnail_image()</span></a></li>
          
        
        <li class="toc-list-item"><a href="#use-sequential-mode-if-you-can"><span class="link-text">Use sequential mode if you can</span></a></li>
          
        
        <li class="toc-list-item"><a href="#use-longer-pipelines-if-you-can"><span class="link-text">Use longer pipelines if you can</span></a></li>
          
        
        <li class="toc-list-item"><a href="#cache-commonly-reused-images"><span class="link-text">Cache commonly reused images</span></a></li>
          
        
        <li class="toc-list-item"><a href="#adjust-the-order-of-operations-in-pipelines"><span class="link-text">Adjust the order of operations in pipelines</span></a></li>
          
        
        <li class="toc-list-item"><a href="#only-enable-the-load-libraries-you-need"><span class="link-text">Only enable the load libraries you need</span></a></li>
          
        
        <li class="toc-list-item"><a href="#sanity-check-images-before-processing"><span class="link-text">Sanity-check images before processing</span></a></li>
          
        
        <li class="toc-list-item"><a href="#linux-memory-allocator"><span class="link-text">Linux memory allocator</span></a></li>
          
        
        <li class="toc-list-item"><a href="#disable-the-libvips-operation-cache-if-you-dont-need-it"><span class="link-text">Disable the libvips operation cache if you don&#39;t need it</span></a></li>
          
        
      
    </ul>
  </nav>
</div>


    <section id="search" class="content hidden"></section>

    <footer>
    
    </footer>
  </div>
</body>
</html>