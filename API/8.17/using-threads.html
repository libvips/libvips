<!--
SPDX-FileCopyrightText: libvips team and contributors

SPDX-License-Identifier: LGPL-2.1-or-later
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <title>Vips &ndash; 8.0: Using &gt; Threads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta charset="utf-8" />

  
  <meta property="og:type" content="website"/>

  

  
  <meta property="og:title" content="Vips: Using &gt; Threads"/>
  <meta property="og:description" content="Reference for Vips-8.0: Using &gt; Threads"/>
  <meta name="twitter:title" content="Vips: Using &gt; Threads"/>
  <meta name="twitter:description" content="Reference for Vips-8.0: Using &gt; Threads"/>


  
  <meta name="twitter:card" content="summary"/>

  
  
  
  <link rel="search" type="application/opensearchdescription+xml" title="Vips" href="opensearch.xml">
  
  

  <link rel="stylesheet" href="style.css" type="text/css" />

  

  
  <script src="urlmap.js"></script>
  
  
  <script src="fzy.js"></script>
  <script src="search.js"></script>
  
  <script src="main.js"></script>

  
</head>

<body>
  <div id="body-wrapper" tabindex="-1">

    <nav class="sidebar devhelp-hidden">
      
      
      <div class="search section">
        <form id="search-form" autocomplete="off">
          <input id="search-input" type="text" name="do-not-autocomplete" placeholder="Click, or press 's' to search" autocomplete="off"/>
        </form>
      </div>
      
      <div class="section namespace">
        <h3><a href="index.html">Vips</a></h3>
        <p>API Version: 8.0</p>
        
        <p>Library Version: 8.17</p>
        
      </div>
      
      
      <div class="section generator">
        <p>Generated by <a href="https://gitlab.gnome.org/GNOME/gi-docgen">gi-docgen</a> 2025.3</p>
      </div>
    </nav>

    <button id="btn-to-top" class="hidden"><span class="up-arrow"></span></button>

    
<section id="main" class="content">
  
  <h4 id="title" style="display:flex;">
    Using &gt; Threads
    <a href="#title" class="anchor"></a>
    
    <a class="srclink" title="go to source location" href="https://github.com/libvips/libvips/blob/master/doc/using-threads.md">[src]</a>
    
  </h4>
  
  <section>
    <div class="docblock">
    <p>This section tries to summarise the rules for threaded programs using
libvips. Generally, libvips is threaded and thread-safe, with a few&nbsp;exceptions.</p>
<h2 id="images">Images<a class="md-anchor" href="#images" title="Permanent link"></a></h2>
<p>On startup, you need to call <a href="func.INIT.html"><code>VIPS_INIT()</code></a> single-threaded. After that,
you can freely create images in any thread and read them in any other
thread. See the example at the end of this chapter.
Note that results can also be shared between threads for you by the
libvips operation&nbsp;cache.</p>
<p>The exception is the drawing operators, such as <a href="method.Image.draw_circle.html"><code>vips_draw_circle()</code></a>.
These operations modify their image argument so you can&#8217;t call them on
the same image from more than one thread. Reading from an image while
another thread is writing to it with one of the draw operations will
obviously also&nbsp;fail.</p>
<p>When libvips calculates an image, by default it will use as many
threads as you have <span class="caps">CPU</span> cores. Use <a href="func.concurrency_set.html"><code>vips_concurrency_set()</code></a> to change&nbsp;this.</p>
<h2 id="error-handling">Error handling<a class="md-anchor" href="#error-handling" title="Permanent link"></a></h2>
<p>libvips has a single error code (-1 or <code>NULL</code>) returned by all functions
on error. Error messages are not returned, instead they are logged
in a single global error buffer shared by all threads, see
<a href="func.error_buffer.html"><code>vips_error_buffer()</code></a>.</p>
<p>This makes error handling very simple but the obvious downside is that
because error returns and error messages are separate, when you
detect an error return you can&#8217;t be
sure that what&#8217;s in the error buffer is the message that matches your&nbsp;error.</p>
<p>The simplest way to handle this is to present the whole error log to
the user on the next interaction and leave it to them to decide what
action caused the&nbsp;failure.</p>
<h2 id="using-vipsregion-between-threads">Using <a href="class.Region.html"><code>VipsRegion</code></a> between threads<a class="md-anchor" href="#using-vipsregion-between-threads" title="Permanent link"></a></h2>
<p><a href="class.Image.html"><code>VipsImage</code></a> objects are immutable and can be shared between
threads very simply. However the lower-level <a href="class.Region.html"><code>VipsRegion</code></a> object
used to implement <a href="class.Image.html"><code>VipsImage</code></a> (see <a href="extending.html">extending libvips</a>) is
mutable and you can only use a <a href="class.Region.html"><code>VipsRegion</code></a> from one thread at&nbsp;once.</p>
<p>In fact it&#8217;s worse than that: to reduce locking, <a href="class.Region.html"><code>VipsRegion</code></a> keeps a
lot of state in per-thread storage. If you want to create a region in
one thread and use it in another, you have to first tag the region as
unowned from the creating thread with <code>vips__region_no_ownership()</code>, then
in the receiving thread take ownership with
<code>vips__region_take_ownership()</code>. See the source for operations like
<a href="method.Image.tilecache.html"><code>vips_tilecache()</code></a> if you&#8217;re curious how this&nbsp;works.</p>
<p>libvips includes a set of sanity checks for region ownership and will
fail if you don&#8217;t pass ownership&nbsp;correctly.</p>
<h2 id="example">Example<a class="md-anchor" href="#example" title="Permanent link"></a></h2>
<p>This example runs many <a href="method.Image.resize.html"><code>vips_resize()</code></a> in parallel from many&nbsp;threads.</p>
<div class="codehilite"><pre><span></span><code><span class="cm">/* Read from many threads.</span>
<span class="cm"> *</span>
<span class="cm"> * Compile with:</span>
<span class="cm"> *</span>
<span class="cm"> *     gcc -g -Wall soak.c `pkg-config vips --cflags --libs`</span>
<span class="cm"> *</span>
<span class="cm"> * Run with:</span>
<span class="cm"> *</span>
<span class="cm"> *     rm -rf x</span>
<span class="cm"> *     mkdir x</span>
<span class="cm"> *     for i in {0..10}; do ./a.out ~/pics/k2.jpg; done</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;glib.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vips/vips.h&gt;</span>

<span class="cm">/* How many pings we run at once.</span>
<span class="cm"> */</span>
<span class="cp">#define NUM_IN_PARALLEL (50)</span>

<span class="cm">/* Number of tests we do in total.</span>
<span class="cm"> */</span>
<span class="cp">#define TOTAL_TESTS (NUM_IN_PARALLEL * 20)</span>

<span class="cm">/* Workers queue up on this.</span>
<span class="cm"> */</span>
<span class="n">GMutex</span><span class="w"> </span><span class="n">allocation_lock</span><span class="p">;</span>

<span class="cm">/* Our set of threads.</span>
<span class="cm"> */</span>
<span class="n">GThread</span><span class="w"> </span><span class="o">*</span><span class="n">workers</span><span class="p">[</span><span class="n">NUM_IN_PARALLEL</span><span class="p">];</span>

<span class="cm">/* Number of calls so far.</span>
<span class="cm"> */</span>
<span class="kt">int</span><span class="w"> </span><span class="n">n_calls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="cm">/* Our test function. This is called by NUM_IN_PARALLEL threads a total of</span>
<span class="cm"> * TOTAL_TESTS times.</span>
<span class="cm"> */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">test</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">VipsImage</span><span class="w"> </span><span class="o">*</span><span class="n">im</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">output_file</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="w">    </span><span class="n">snprintf</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span><span class="w"> </span><span class="mi">256</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;x/tmp-%p.jpg&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">g_thread_self</span><span class="p">());</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">im</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vips_image_new_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
<span class="w">              </span><span class="s">&quot;access&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">VIPS_ACCESS_SEQUENTIAL</span><span class="p">,</span>
<span class="w">              </span><span class="nb">NULL</span><span class="p">)))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vips_resize</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">g_object_unref</span><span class="p">(</span><span class="n">im</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">g_object_unref</span><span class="p">(</span><span class="n">im</span><span class="p">);</span>
<span class="w">    </span><span class="n">im</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vips_image_write_to_file</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="w"> </span><span class="n">output_file</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">g_object_unref</span><span class="p">(</span><span class="n">im</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">g_object_unref</span><span class="p">(</span><span class="n">im</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* What we run as a thread.</span>
<span class="cm"> */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
<span class="nf">worker</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">gboolean</span><span class="w"> </span><span class="n">done</span><span class="p">;</span>

<span class="w">        </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
<span class="w">        </span><span class="n">g_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">allocation_lock</span><span class="p">);</span>
<span class="w">        </span><span class="n">n_calls</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n_calls</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">TOTAL_TESTS</span><span class="p">)</span>
<span class="w">            </span><span class="n">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="n">g_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">allocation_lock</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">test</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
<span class="w">            </span><span class="n">vips_error_exit</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">VIPS_INIT</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="w">        </span><span class="n">vips_error_exit</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUM_IN_PARALLEL</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">workers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g_thread_new</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">GThreadFunc</span><span class="p">)</span><span class="w"> </span><span class="n">worker</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUM_IN_PARALLEL</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">g_thread_join</span><span class="p">(</span><span class="n">workers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
    </div>
  </section>
</section>


    
<div id="toc" class="toc">
  <nav aria-labelledby="toc-title">
    <p id="toc-title">Content</p>
    <ul class="toc-list">
      
        
        <li class="toc-list-item"><a href="#images"><span class="link-text">Images</span></a></li>
          
        
        <li class="toc-list-item"><a href="#error-handling"><span class="link-text">Error handling</span></a></li>
          
        
        <li class="toc-list-item"><a href="#using-vipsregion-between-threads"><span class="link-text">Using VipsRegion between threads</span></a></li>
          
        
        <li class="toc-list-item"><a href="#example"><span class="link-text">Example</span></a></li>
          
        
      
    </ul>
  </nav>
</div>


    <section id="search" class="content hidden"></section>

    <footer>
    
    </footer>
  </div>
</body>
</html>