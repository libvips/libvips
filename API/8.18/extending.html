<!--
SPDX-FileCopyrightText: libvips team and contributors

SPDX-License-Identifier: LGPL-2.1-or-later
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <title>Vips &ndash; 8.0: Advanced &gt; Writing operators</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta charset="utf-8" />

  
  <meta property="og:type" content="website"/>

  

  
  <meta property="og:title" content="Vips: Advanced &gt; Writing operators"/>
  <meta property="og:description" content="Reference for Vips-8.0: Advanced &gt; Writing operators"/>
  <meta name="twitter:title" content="Vips: Advanced &gt; Writing operators"/>
  <meta name="twitter:description" content="Reference for Vips-8.0: Advanced &gt; Writing operators"/>


  
  <meta name="twitter:card" content="summary"/>

  
  
  
  <link rel="search" type="application/opensearchdescription+xml" title="Vips" href="opensearch.xml">
  
  

  <link rel="stylesheet" href="style.css" type="text/css" />

  

  
  <script src="urlmap.js"></script>
  
  
  <script src="fzy.js"></script>
  <script src="search.js"></script>
  
  <script src="main.js"></script>

  
</head>

<body>
  <div id="body-wrapper" tabindex="-1">

    <nav class="sidebar devhelp-hidden">
      
      
      <div class="search section">
        <form id="search-form" autocomplete="off">
          <input id="search-input" type="text" name="do-not-autocomplete" placeholder="Click, or press 's' to search" autocomplete="off"/>
        </form>
      </div>
      
      <div class="section namespace">
        <h3><a href="index.html">Vips</a></h3>
        <p>API Version: 8.0</p>
        
        <p>Library Version: 8.18</p>
        
      </div>
      
      
      <div class="section generator">
        <p>Generated by <a href="https://gitlab.gnome.org/GNOME/gi-docgen">gi-docgen</a> 2025.3</p>
      </div>
    </nav>

    <button id="btn-to-top" class="hidden"><span class="up-arrow"></span></button>

    
<section id="main" class="content">
  
  <h4 id="title" style="display:flex;">
    Advanced &gt; Writing operators
    <a href="#title" class="anchor"></a>
    
    <a class="srclink" title="go to source location" href="https://github.com/libvips/libvips/blob/master/doc/extending.md">[src]</a>
    
  </h4>
  
  <section>
    <div class="docblock">
    <p>This section runs quickly through adding a simple operator to libvips.
For more information, see <a href="class.Operation.html"><code>VipsOperation</code></a> and <a href="class.Region.html"><code>VipsRegion</code></a>. A good
starting point for a new operation is a similar one in&nbsp;libvips.</p>
<p>All libvips operations are subclasses of <a href="class.Operation.html"><code>VipsOperation</code></a>, which in turn
subclasses <a href="class.Object.html"><code>VipsObject</code></a> and then <a href="javascript:void(0)" data-namespace="GObject" data-link="class.Object.html" class="external"><code>GObject</code></a>. You add an
operation to libvips by defining a new subclass of <a href="class.Operation.html"><code>VipsOperation</code></a> and
arranging for its <code>class_init()</code> to be called, perhaps by calling its
<code>get_type()</code> function.</p>
<h2 id="the-class-and-object-structures">The class and object structures<a class="md-anchor" href="#the-class-and-object-structures" title="Permanent link"></a></h2>
<p>First you need to define a new object struct and a new class&nbsp;struct.</p>
<div class="codehilite"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_Negative</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">VipsOperation</span><span class="w"> </span><span class="n">parent_instance</span><span class="p">;</span>

<span class="w">  </span><span class="n">VipsImage</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="p">;</span>
<span class="w">  </span><span class="n">VipsImage</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">;</span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">image_max</span><span class="p">;</span>

<span class="p">}</span><span class="w"> </span><span class="n">Negative</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_NegativeClass</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">VipsOperationClass</span><span class="w"> </span><span class="n">parent_class</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* No new class members needed for this op.</span>
<span class="cm">   */</span>

<span class="p">}</span><span class="w"> </span><span class="n">NegativeClass</span><span class="p">;</span>
</code></pre></div>

<p>This operation will find the photographic negative of an unsigned 8-bit
image, optionally letting you specify the value which the pixels &#8220;pivot&#8221;
about. It doesn&#8217;t need any class members (ie. values common to all operations
of this type), so the second struct is empty. See the source to
<a href="method.Image.invert.html"><code>vips_invert()</code></a> for a more complete version of this operation that&#8217;s
actually in the&nbsp;library.</p>
<p><a href="javascript:void(0)" data-namespace="GObject" data-link="class.Object.html" class="external"><code>GObject</code></a> has a handy macro to write some of the boilerplate for&nbsp;you.</p>
<div class="codehilite"><pre><span></span><code><span class="n">G_DEFINE_TYPE</span><span class="p">(</span><span class="n">Negative</span><span class="p">,</span><span class="w"> </span><span class="n">negative</span><span class="p">,</span><span class="w"> </span><span class="n">VIPS_TYPE_OPERATION</span><span class="p">);</span>
</code></pre></div>

<p><a href="javascript:void(0)" data-namespace="GObject" data-link="func.DEFINE_TYPE.html" class="external"><code>G_DEFINE_TYPE()</code></a> defines a function called <code>negative_get_type()</code>,
which registers this new class and returns its <a href="javascript:void(0)" data-namespace="GObject" data-link="alias.Type.html" class="external"><code>GType</code></a> (a
pointer-sized integer). <code>negative_get_type()</code> in turn needs two functions,
<code>negative_init()</code>, to initialise a new instance, and <code>negative_class_init()</code>,
to initialise a new&nbsp;class.</p>
<h2 id="class-and-object-initialisation">Class and object initialisation<a class="md-anchor" href="#class-and-object-initialisation" title="Permanent link"></a></h2>
<p><code>negative_init()</code> is very simple, it just sets the default value for our
optional&nbsp;parameter.</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">negative_init</span><span class="p">(</span><span class="n">Negative</span><span class="w"> </span><span class="o">*</span><span class="n">negative</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">negative</span><span class="o">-&gt;</span><span class="n">image_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">255</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><code>negative_class_init()</code> is more complicated: it has to set various fields in
various superclasses and define the operation&#8217;s&nbsp;parameters.</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">negative_class_init</span><span class="p">(</span><span class="n">NegativeClass</span><span class="w"> </span><span class="o">*</span><span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">GObjectClass</span><span class="w"> </span><span class="o">*</span><span class="n">gobject_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">G_OBJECT_CLASS</span><span class="p">(</span><span class="n">class</span><span class="p">);</span>
<span class="w">    </span><span class="n">VipsObjectClass</span><span class="w"> </span><span class="o">*</span><span class="n">object_class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VIPS_OBJECT_CLASS</span><span class="p">(</span><span class="n">class</span><span class="p">);</span>

<span class="w">    </span><span class="n">gobject_class</span><span class="o">-&gt;</span><span class="n">set_property</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vips_object_set_property</span><span class="p">;</span>
<span class="w">    </span><span class="n">gobject_class</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vips_object_get_property</span><span class="p">;</span>

<span class="w">    </span><span class="n">object_class</span><span class="o">-&gt;</span><span class="n">nickname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;negative&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">object_class</span><span class="o">-&gt;</span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;photographic negative&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">object_class</span><span class="o">-&gt;</span><span class="n">build</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">negative_build</span><span class="p">;</span>

<span class="w">    </span><span class="n">VIPS_ARG_IMAGE</span><span class="p">(</span><span class="n">class</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;in&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Input&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Input image&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">VIPS_ARGUMENT_REQUIRED_INPUT</span><span class="p">,</span>
<span class="w">        </span><span class="n">G_STRUCT_OFFSET</span><span class="p">(</span><span class="n">Negative</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">));</span>

<span class="w">    </span><span class="n">VIPS_ARG_IMAGE</span><span class="p">(</span><span class="n">class</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;out&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Output&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Output image&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">VIPS_ARGUMENT_REQUIRED_OUTPUT</span><span class="p">,</span>
<span class="w">        </span><span class="n">G_STRUCT_OFFSET</span><span class="p">(</span><span class="n">Negative</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">));</span>

<span class="w">    </span><span class="n">VIPS_ARG_INT</span><span class="p">(</span><span class="n">class</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;image_max&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Image maximum&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Maximum value in image: pivot about this&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">VIPS_ARGUMENT_OPTIONAL_INPUT</span><span class="p">,</span>
<span class="w">        </span><span class="n">G_STRUCT_OFFSET</span><span class="p">(</span><span class="n">Negative</span><span class="p">,</span><span class="w"> </span><span class="n">image_max</span><span class="p">),</span>
<span class="w">        </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="mi">255</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>In <a href="javascript:void(0)" data-namespace="GObject" data-link="class.Object.html" class="external"><code>GObject</code></a>, it needs to set the getters and setters for this
class. libvips has a generic get/set system, so any subclass of
<a href="class.Object.html"><code>VipsObject</code></a> needs to use the libvips&nbsp;ones.</p>
<p>In <a href="class.Object.html"><code>VipsObject</code></a>, it needs to set the operation
<a href="property.Object.nickname.html"><code>VipsObject:nickname</code></a> and <a href="property.Object.description.html"><code>VipsObject:description</code></a>, and set
a build function (see below). <a href="property.Object.nickname.html"><code>VipsObject:nickname</code></a> is used to refer
to this operation in the <span class="caps">API</span>, <a href="property.Object.description.html"><code>VipsObject:description</code></a> is used to
explain this operation to users and will be translated into their&nbsp;language.</p>
<p>Finally, it needs to define the arguments the constructor for this class
takes. There are a set of handy macros for doing this, see <a href="func.ARG_INT.html"><code>VIPS_ARG_INT()</code></a>
and&nbsp;friends.</p>
<p>The first few parameters are always the same and mean: class pointer for
argument, argument name, argument priority (bindings expect required arguments
in order of priority), long argument name (this one is internationalised
and displayed to users), description (again, users can see this), some flags
describing the argument, and finally the position of the member in the&nbsp;struct.</p>
<p>Integer arguments take three more values: the minimum, maximum and
default value for the&nbsp;argument.</p>
<h2 id="the-build-function">The <code>build()</code> function<a class="md-anchor" href="#the-build-function" title="Permanent link"></a></h2>
<p>The build function is the thing <a href="class.Object.html"><code>VipsObject</code></a> calls during object construction,
after all arguments have been supplied and before the object is used. It
has two roles: to verify that arguments are correct, and then to construct
the object.  After <code>build()</code>, the object is expected to be ready for&nbsp;use.</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">negative_build</span><span class="p">(</span><span class="n">VipsObject</span><span class="w"> </span><span class="o">*</span><span class="n">object</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">VipsObjectClass</span><span class="w"> </span><span class="o">*</span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VIPS_OBJECT_GET_CLASS</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
<span class="w">    </span><span class="n">Negative</span><span class="w"> </span><span class="o">*</span><span class="n">negative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Negative</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">object</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">VIPS_OBJECT_CLASS</span><span class="p">(</span><span class="n">negative_parent_class</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">build</span><span class="p">(</span><span class="n">object</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vips_check_uncoded</span><span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">nickname</span><span class="p">,</span><span class="w"> </span><span class="n">negative</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">        </span><span class="n">vips_check_format</span><span class="p">(</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">nickname</span><span class="p">,</span><span class="w"> </span><span class="n">negative</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">VIPS_FORMAT_UCHAR</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="n">g_object_set</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;out&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">vips_image_new</span><span class="p">(),</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vips_image_pipelinev</span><span class="p">(</span><span class="n">negative</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span>
<span class="w">            </span><span class="n">VIPS_DEMAND_STYLE_THINSTRIP</span><span class="p">,</span><span class="w"> </span><span class="n">negative</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vips_image_generate</span><span class="p">(</span><span class="n">negative</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span>
<span class="w">            </span><span class="n">vips_start_one</span><span class="p">,</span>
<span class="w">            </span><span class="n">negative_generate</span><span class="p">,</span>
<span class="w">            </span><span class="n">vips_stop_one</span><span class="p">,</span>
<span class="w">            </span><span class="n">negative</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">negative</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><code>negative_build()</code> first chains up to the superclass: this will check that
all input arguments have been supplied and are&nbsp;sane.</p>
<p>Next, it adds its own checks. This is a demo operation, so we just work for
uncoded, unsigned 8-bit images. There are a lot of convenience functions
like <a href="func.check_format.html"><code>vips_check_format()</code></a>, see the&nbsp;docs.</p>
<p>Next, it creates the output image. This needs to be set with <a href="method.Object.set.html"><code>vips_object_set()</code></a>
so that libvips can see that it has been assigned. libvips will also handle the
reference counting for&nbsp;you.</p>
<p><a href="method.Image.pipelinev.html"><code>vips_image_pipelinev()</code></a> links our new image onto the input image and notes
that this operation prefers to work in lines. You can request other input
geometries, see <a href="enum.DemandStyle.html"><code>VipsDemandStyle</code></a>.</p>
<p>The geometry hint is just a hint, an operation needs to be able to supply any
size <a href="class.Region.html"><code>VipsRegion</code></a> on request. If you must have a certain size request, you
can put a cache in the pipeline after your operation, see
<a href="method.Image.linecache.html"><code>vips_linecache()</code></a> and <a href="method.Image.tilecache.html"><code>vips_tilecache()</code></a>. You can also make requests
to your operation ordered, see <a href="method.Image.sequential.html"><code>vips_sequential()</code></a>.</p>
<p>Finally, <a href="method.Image.generate.html"><code>vips_image_generate()</code></a> attaches a set of callbacks to the output
image to generate chunks of it on request. <a href="func.start_one.html"><code>vips_start_one()</code></a> and <a href="func.stop_one.html"><code>vips_stop_one()</code></a>
are convenience functions that make the input region for you, see&nbsp;below.</p>
<h2 id="the-generate-function">The <code>generate()</code> function<a class="md-anchor" href="#the-generate-function" title="Permanent link"></a></h2>
<p>The <code>generate()</code> function does the actual image processing. <code>negative_generate()</code>
(of type <a href="callback.GenerateFn.html"><code>VipsGenerateFn</code></a>, supplied to <a href="method.Image.generate.html"><code>vips_image_generate()</code></a> above) is
called  whenever some pixels of our output image are&nbsp;required.</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">negative_generate</span><span class="p">(</span><span class="n">VipsRegion</span><span class="w"> </span><span class="o">*</span><span class="n">out_region</span><span class="p">,</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">vseq</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">gboolean</span><span class="w"> </span><span class="o">*</span><span class="n">stop</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="cm">/* The area of the output region we have been asked to make.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">VipsRect</span><span class="w"> </span><span class="o">*</span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out_region</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* The sequence value ... the thing returned by vips_start_one().</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">VipsRegion</span><span class="w"> </span><span class="o">*</span><span class="n">ir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">VipsRegion</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">vseq</span><span class="p">;</span>

<span class="w">    </span><span class="n">VipsImage</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">VipsImage</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="n">Negative</span><span class="w"> </span><span class="o">*</span><span class="n">negative</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Negative</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">line_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">negative</span><span class="o">-&gt;</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">Bands</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Request matching part of input region.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vips_region_prepare</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span>
<span class="w">            </span><span class="n">VIPS_REGION_ADDR</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">top</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span>
<span class="w">            </span><span class="n">VIPS_REGION_ADDR</span><span class="p">(</span><span class="n">out_region</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">-&gt;</span><span class="n">top</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">line_size</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="n">q</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">negative</span><span class="o">-&gt;</span><span class="n">image_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p</span><span class="p">[</span><span class="n">x</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>This has to calculate a section of the output image. The output
<a href="class.Region.html"><code>VipsRegion</code></a>, <code>out_region</code>, contains a <a href="struct.Rect.html"><code>VipsRect</code></a> called <code>valid</code>
which is the area needing calculation. This call to <code>negative_generate()</code>
must somehow make this part of <code>out_region</code> contain pixel&nbsp;data.</p>
<p><code>vseq</code> is the sequence value. This is the per-thread state for this generate,
created (in this example) by <a href="func.start_one.html"><code>vips_start_one()</code></a>. In this simple case it&#8217;s
just a <a href="class.Region.html"><code>VipsRegion</code></a> defined on the input image. If you need more per-thread
state you can write your own start and stop functions and have a struct
you create and pass as a sequence value. There are plenty of examples in
the libvips source code, see <a href="method.Image.rank.html"><code>vips_rank()</code></a>.</p>
<p><code>a</code> and <code>b</code> are the last two arguments to <a href="method.Image.generate.html"><code>vips_image_generate()</code></a> above.
<code>stop</code> is a bool pointer you can set to stop computation early.
<a href="method.Image.min.html"><code>vips_min()</code></a> on an unsigned int image, for example, will set <code>stop</code>
as soon as it sees a zero, and will not scan the entire&nbsp;image.</p>
<p>The first thing <code>negative_generate()</code> does is use <a href="method.Region.prepare.html"><code>vips_region_prepare()</code></a> to
ask for the corresponding pixels from the input image. Operations which do
coordinate transforms or which need an area of input for each output point
will need to calculate a new rect before calling <a href="method.Region.prepare.html"><code>vips_region_prepare()</code></a>.</p>
<p>Finally, it can calculate some pixels. <code>negative_generate()</code> loops over the
valid area of the output and calls <a href="func.REGION_ADDR.html"><code>VIPS_REGION_ADDR()</code></a> for each line. This
macro is reasonably quick, but it&#8217;s best not to call it for each pixel. Once
per line is fine&nbsp;though.</p>
<h2 id="adding-to-libvips">Adding to libvips<a class="md-anchor" href="#adding-to-libvips" title="Permanent link"></a></h2>
<p>To add the operation to libvips, just call <code>negative_get_type()</code>. You can
include the source in your program, or use <a href="https://docs.gtk.org/gmodule/">GModule</a> to make a binary plugin that will be loaded
by libvips at startup. There are some <a href="https://github.com/jcupitt/vips-gmic">example plugins available</a>.</p>
<p>You can then use <code>negative</code> from any of the libvips interfaces. For example,
in Python you&#8217;d use it like&nbsp;this:</p>
<div class="codehilite"><pre><span></span><code><span class="n">out</span> <span class="o">=</span> <span class="ow">in</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="n">image_max</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
</code></pre></div>

<p>From the command-line it&#8217;d look like&nbsp;this:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>vips<span class="w"> </span>negative<span class="w"> </span><span class="k">in</span>.png<span class="w"> </span>out.tif<span class="w"> </span>--image-max<span class="w"> </span><span class="m">128</span>
</code></pre></div>

<p>And from C like&nbsp;this:</p>
<div class="codehilite"><pre><span></span><code><span class="n">VipsImage</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="p">;</span>
<span class="n">VipsImage</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vips_call</span><span class="p">(</span><span class="s">&quot;negative&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;image_max&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span>
<span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="n">error</span>
</code></pre></div>

<p>Unfortunately that will do almost no compile-time type checking, so all
libvips operations have a tiny extra wrapper to add a bit of safety. For&nbsp;example:</p>
<div class="codehilite"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">negative</span><span class="p">(</span><span class="n">VipsImage</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">VipsImage</span><span class="w"> </span><span class="o">**</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">va_list</span><span class="w"> </span><span class="n">ap</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>

<span class="w">    </span><span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">);</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vips_call_split</span><span class="p">(</span><span class="s">&quot;negative&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ap</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">);</span>
<span class="w">    </span><span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>And now you can&nbsp;write:</p>
<div class="codehilite"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">negative</span><span class="p">(</span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;image_max&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span>
<span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="n">error</span>
</code></pre></div>

<p>and it&#8217;s at least a bit&nbsp;safer.</p>
<h2 id="other-types-of-operation">Other types of operation<a class="md-anchor" href="#other-types-of-operation" title="Permanent link"></a></h2>
<p>Change the <code>_build()</code> function to make other types of&nbsp;operation.</p>
<p>Use <a href="method.Image.generate.html"><code>vips_image_generate()</code></a> with <a href="func.start_many.html"><code>vips_start_many()</code></a> to make operations which
demand pixels from more than one image at once, such as image plus&nbsp;image.</p>
<p>Use <a href="method.Image.sink.html"><code>vips_sink()</code></a> instead of <a href="method.Image.generate.html"><code>vips_image_generate()</code></a> to loop over an
image and calculate a value. libvips uses this for the statistics operations,
like <a href="method.Image.avg.html"><code>vips_avg()</code></a>.</p>
<p>Use <a href="method.Image.wio_input.html"><code>vips_image_wio_input()</code></a> to get an entire image into memory so you can
read it with a pointer. This will obviously not scale well to very large
images, but some operations, like FFTs or flood-fill, need the whole image
to be available at&nbsp;once.</p>
<p>Make area operations, like filters, by enlarging the <a href="struct.Rect.html"><code>VipsRect</code></a> that
<code>_generate()</code> is given before calling <a href="method.Region.prepare.html"><code>vips_region_prepare()</code></a>. You can enlarge
the input image, so that the output image is the same size as the original
input, by using <a href="method.Image.embed.html"><code>vips_embed()</code></a> within the <code>_build()</code> function.</p>
<p>Make things like flips and rotates by making larger changes to the <a href="struct.Rect.html"><code>VipsRect</code></a>
in <code>_generate()</code>.</p>
<p>Make zero-copy operations, like <a href="method.Image.insert.html"><code>vips_insert()</code></a>, with
<a href="method.Region.region.html"><code>vips_region_region()</code></a>.</p>
    </div>
  </section>
</section>


    
<div id="toc" class="toc">
  <nav aria-labelledby="toc-title">
    <p id="toc-title">Content</p>
    <ul class="toc-list">
      
        
        <li class="toc-list-item"><a href="#the-class-and-object-structures"><span class="link-text">The class and object structures</span></a></li>
          
        
        <li class="toc-list-item"><a href="#class-and-object-initialisation"><span class="link-text">Class and object initialisation</span></a></li>
          
        
        <li class="toc-list-item"><a href="#the-build-function"><span class="link-text">The build() function</span></a></li>
          
        
        <li class="toc-list-item"><a href="#the-generate-function"><span class="link-text">The generate() function</span></a></li>
          
        
        <li class="toc-list-item"><a href="#adding-to-libvips"><span class="link-text">Adding to libvips</span></a></li>
          
        
        <li class="toc-list-item"><a href="#other-types-of-operation"><span class="link-text">Other types of operation</span></a></li>
          
        
      
    </ul>
  </nav>
</div>


    <section id="search" class="content hidden"></section>

    <footer>
    
    </footer>
  </div>
</body>
</html>